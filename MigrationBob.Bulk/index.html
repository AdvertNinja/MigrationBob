<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>MigrationBob | Bulk auditor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./../styly.css">
</head>
<body>
  <div class="container">
    <img class="hero" src="https://cemex.advert.ninja/tools/MigrationBob/migrationbob-300x300.webp" alt="MigrationBob">
    <h1>Migration Bob — Bulk</h1>
    <p class="lead">Audit celého webu po zemi</p>

    <form id="bulkForm" class="stack">
      <label for="country" class="small muted">Země</label>
      <select id="country" required>
        <option value="CZE">CZE</option>
        <option value="FRA">FRA</option>
        <option value="ESP">ESP</option>
        <option value="DEU">DEU</option>
        <option value="POL">POL</option>
        <option value="SVK">SVK</option>
        <option value="HUN">HUN</option>
      </select>
      <button id="runBulkBtn" type="submit">Run Bulk Audit</button>
    </form>

    <div id="bulkStatus" class="status"></div>
    <div id="bulkProgress" class="small mono"></div>
    <div id="bulkLink" class="small"></div>

    <ul id="jarvisLog"></ul>
  </div>

<script>
  const API = 'https://migrationbob-api.onrender.com';

  const bulkForm = document.getElementById('bulkForm');
  const countrySel = document.getElementById('country');
  const runBulkBtn = document.getElementById('runBulkBtn');
  const bulkStatus = document.getElementById('bulkStatus');
  const bulkProgress = document.getElementById('bulkProgress');
  const bulkLink = document.getElementById('bulkLink');
  const jarvisLog = document.getElementById('jarvisLog');

  function logJarvis(msg) {
    const li = document.createElement('li');
    li.textContent = msg;
    jarvisLog.appendChild(li);
  }

  function setBusy(b, msg='') {
    runBulkBtn.disabled = b;
    bulkStatus.textContent = msg;
  }

  async function startBulk(country) {
    const r = await fetch(`${API}/bulk/run?country=${encodeURIComponent(country)}`, { method: 'POST' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  bulkForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const country = countrySel.value;

    bulkLink.textContent = '';
    bulkProgress.textContent = '';
    jarvisLog.innerHTML = '';
    setBusy(true, `Spouštím bulk audit pro ${country}…`);
    logJarvis(`Bulk start ${country}`);

    try {
      const { jobId } = await startBulk(country);
      if (!jobId) throw new Error('Missing jobId');

      const es = new EventSource(`${API}/bulk/stream/${jobId}`);

      es.addEventListener('start', (ev) => {
        const d = JSON.parse(ev.data);
        bulkProgress.textContent = `Progress: 0/${d.total} (0%)`;
      });

      es.addEventListener('progress', (ev) => {
        const d = JSON.parse(ev.data);
        bulkStatus.textContent = `Kontroluji: ${d.index}/${d.total}`;
      });

      es.addEventListener('result', (ev) => {
        const d = JSON.parse(ev.data);
        const pct = Math.round((d.index / d.total) * 100);
        bulkProgress.textContent = `Progress: ${d.index}/${d.total} (${pct}%)`;
        logJarvis(`${d.index}/${d.total} ${d.url} → ${d.allOk ? 'OK' : 'NOK'}`);
      });

      es.addEventListener('done', (ev) => {
        const d = JSON.parse(ev.data);
        setBusy(false, 'Hotovo.');
        bulkLink.innerHTML = d.outputUrl ? `Výsledek: <a href="${d.outputUrl}" target="_blank">${d.outputUrl}</a>` : '';
        logJarvis('Bulk done');
        es.close();
      });

      es.addEventListener('error', () => {
        setBusy(false, 'Chyba při běhu auditu.');
        logJarvis('Bulk error');
        es.close();
      });
    } catch (err) {
      console.error(err);
      setBusy(false, 'Bulk start failed');
      logJarvis('Bulk start failed');
    }
  });
</script>

</body>
</html>
