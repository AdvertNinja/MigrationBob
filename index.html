<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>MigrationBob | Your friendly quality auditor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styly.css">
  
</head>
<body>
  <div class="container">
    <img class="hero" src="https://cemex.advert.ninja/tools/MigrationBob/migrationbob-300x300.webp" alt="MigrationBob">
    <h1>Migration Bob</h1>
    <p class="lead">Your friendly quality auditor</p>

    <form id="auditForm">
      <input id="urlInput" type="url" placeholder="https://cxprod-web.cemex.com/cs/web/cemex-cz/produkty/kamenivo" required />
      <button id="runBtn" type="submit">Let Bob have a look!</button>
    </form>

    <div id="status" class="status"></div>

    <div id="result" style="display:none;">
      <div id="summary" class="summary"></div>
      <ul id="checks" class="checks"></ul>
      <div id="meta" class="small"></div>
    </div>

    <ul id="jarvisLog"></ul>
  </div>

<script>
const API = 'https://migrationbob-api.onrender.com';
//const API = 'https://cemex.advert.ninja';

  const form   = document.getElementById('auditForm');
  const input  = document.getElementById('urlInput');
  const runBtn = document.getElementById('runBtn');
  const status = document.getElementById('status');
  const resultBox = document.getElementById('result');
  const summary = document.getElementById('summary');
  const checksUl = document.getElementById('checks');
  const meta = document.getElementById('meta');
  const jarvisLog = document.getElementById('jarvisLog');

  function logJarvis(message, detail='') {
    const prefix = '%cJarvis:';
    const style = 'background:#fff;color:#000;padding:4px 6px;border-radius:4px;font-weight:600;font-family:Poppins,sans-serif;';
    console.log(prefix, style, message, detail);
    const li = document.createElement('li');
    li.textContent = message + (detail ? ' ' + detail : '');
    jarvisLog.appendChild(li);
  }

  function setBusy(busy, msg='') {
    runBtn.disabled = busy;
    status.innerHTML = busy ? `<span class="spinner"></span>${msg || 'Volám API, vydrž chvilku…'}` : (msg || '');
  }

  function li(check) {
    const el = document.createElement('li');
    const badge = document.createElement('span');
    badge.textContent = check.Ok ? '✓' : '✗';
    badge.className = check.Ok ? 'ok' : 'není ok';
    el.appendChild(badge);

    const textWrap = document.createElement('div');
    const title = document.createElement('div');
    title.textContent = check.Check;
    textWrap.appendChild(title);

    if (check.Details) {
      const details = document.createElement('div');
      details.className = 'muted';
      details.textContent = check.Details;
      textWrap.appendChild(details);
    }
    el.appendChild(textWrap);
    return el;
  }

  async function callAudit(url) {
    const endpoint = `${API}/audit?url=${encodeURIComponent(url)}`;
    let attempt = 0, lastErr;
    while (attempt < 2) {
      try {
        logJarvis('Posíláme noticku na Backenf');
        const r = await fetch(endpoint, { method: 'GET' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        logJarvis('Backend jede, parsujeme JSOn');
        return await r.json();
      } catch (e) {
        lastErr = e;
        logJarvis('Backend spí, tohle se změní, až to spustíme na lepčím serveru');
        attempt++;
        if (attempt < 2) await new Promise(res => setTimeout(res, 1500));
      }
    }
    throw lastErr;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const url = input.value.trim();
    if (!url) return;

    resultBox.style.display = 'none';
    checksUl.innerHTML = '';
    meta.textContent = '';

    logJarvis('Máme URL:', url);
    setBusy(true, 'Bob začal zkoumat');

    try {
      const data = await callAudit(url);

      logJarvis('Bob má hotovo, rendrujeme UI');

      summary.textContent = data.AllOk ? 'Super, všechno splněno!' : 'Ještě je potřeba doladit pár věcí:';
      summary.className = `summary ${data.AllOk ? 'pass' : 'fail'}`;

      (data.Checks || []).forEach(c => checksUl.appendChild(li(c)));

      const finalUrl = data.FinalUrl || data.Url || url;
      const httpStatus = data.HttpStatus != null ? `HTTP ${data.HttpStatus}` : '';
      meta.innerHTML = [
        finalUrl ? `Cílová URL: <span class="mono">${finalUrl}</span>` : '',
        httpStatus
      ].filter(Boolean).join(' · ');

      resultBox.style.display = 'block';
      setBusy(false, 'Hotovo.');
      logJarvis('Delivered! Yummy!');

      fetch('https://cemex.advert.ninja/tools/MigrationBob/odeslani-vysledku.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, allOk: data.AllOk, result: data.Checks })
      })
      .then(r => r.json())
      .then(res => logJarvis(res.status === 'success' ? 'Audit e-mail úspěšně odeslán!' : 'Audit e-mail se nepodařilo odeslat.'))
      .catch(() => logJarvis('Chyba při odesílání e-mailu.'));
    } catch (err) {
      console.error(err);
      logJarvis('Backend spadnul...');
      setBusy(false, 'Jiná chbya backendu, to bude na render.com v logu');
    }
  });
</script>
</body>
</html>
